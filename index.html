<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Извлечение чисел и проверка дубликатов</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }
        textarea {
            width: 100%;
            height: 150px;
            margin-bottom: 20px;
            resize: none;
            white-space: nowrap;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: #4CAF50;
            color: white;
            border: none;
            cursor: pointer;
            margin-right: 10px;
            margin-bottom: 5px;
        }
        button:hover {
            background-color: #307332;
        }
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 10px;
        }
        label {
            font-size: 18px;
            font-weight: bold;
        }
        #copyBtn {
            background-color: #008CBA;
        }
        #copyBtn:hover {
            background-color: #006fa3;
        }
        .highlight-duplicate {
            color: red;
            font-weight: bold;
        }
        .numbered-links {
            counter-reset: link-counter;
        }
        .numbered-links div {
            counter-increment: link-counter;
        }
        .numbered-links div::before {
            content: counter(link-counter) ". ";
            font-weight: bold;
            margin-right: 10px;
        }
        .clear-btn {
            cursor: pointer;
            color: red;
            margin-left: 10px;
            font-weight: bold;
        }
    </style>
</head>
<body>

<div class="container">
    <label for="linksInput">Вставьте ссылки (каждая с новой строки):</label>
    <span class="clear-btn" onclick="clearFields()">Очистить поле ✖</span>
    <br>
    <br>

    <textarea id="linksInput" oninput="updateLinks()"></textarea>
    <br>
    <button id="copyDuplicatesBtn" onclick="copyDuplicateLinks()">Скопировать дублирующиеся ссылки</button>
    <button id="copyUniqueLinksBtn" onclick="copyUniqueLinks()">Скопировать уникальные ссылки</button>
    <br>
    <br>
    <label for="linksOutput">Результат (дубликаты ссылок подсвечены красным):</label>
    <div class="numbered-links" id="linksOutput" style="border: 1px solid #ccc; padding: 10px; min-height: 150px; white-space: pre-wrap; font-size: 12px;"></div>
</div>

<div class="container">
    <button onclick="extractNumbers()">Извлечь числа</button>
    <button id="copyBtn" onclick="copyToClipboard()">Скопировать результат</button>
    <br>
    <br>
    <label for="numbersOutput">Результат (дубликаты чисел подсвечены красным):</label>
    <div id="numbersOutput" style="white-space: pre-wrap; border: 1px solid #ccc; padding: 10px; min-height: 150px; font-size: 12px;"></div>
</div>

<script>
    let duplicateLinks = new Set(); // Хранит дублирующиеся ссылки
    let uniqueLinks = new Set(); // Хранит уникальные ссылки

    // Обновляем список ссылок с нумерацией и проверкой на дубликаты
    function updateLinks() {
        const input = document.getElementById('linksInput').value;
        const links = input.split('\n').map(link => link.trim()).filter(link => link.length > 0);

        const allLinks = new Set();
        duplicateLinks.clear(); // Очищаем дублирующиеся ссылки
        uniqueLinks.clear(); // Очищаем уникальные ссылки

        // Проверяем на дубликаты
        links.forEach(link => {
            if (allLinks.has(link)) {
                duplicateLinks.add(link); // Добавляем в дублирующиеся
            } else {
                allLinks.add(link);
                uniqueLinks.add(link); // Добавляем в уникальные
            }
        });

        // Формируем вывод с нумерацией и подсветкой дубликатов
        const linksOutput = document.getElementById('linksOutput');
        linksOutput.innerHTML = links.map(link =>
            duplicateLinks.has(link) ? `<div class="highlight-duplicate">${link}</div>` : `<div>${link}</div>`
        ).join('');
    }

    // Извлекаем числа из ссылок и подсвечиваем дубликаты
    function extractNumbers() {
        const links = document.getElementById('linksInput').value.split('\n').map(link => link.trim()).filter(link => link.length > 0);

        let numbers = [];
        let duplicates = new Set();
        let uniqueNumbers = new Set();

        // Извлекаем последние числа после символа "_" и обрезаем по "?"
        links.forEach(link => {
            const trimmedLink = link.split('?')[0]; // Убираем часть после знака ?
            const lastUnderscoreIndex = trimmedLink.lastIndexOf('_');
            if (lastUnderscoreIndex !== -1) {
                const number = trimmedLink.substring(lastUnderscoreIndex + 1).trim();
                if (uniqueNumbers.has(number)) {
                    duplicates.add(number);
                } else {
                    uniqueNumbers.add(number);
                }
                numbers.push(number);
            }
        });

        // Выводим результат с подсветкой дубликатов
        const numbersOutput = document.getElementById('numbersOutput');
        numbersOutput.innerHTML = numbers.map(number =>
            duplicates.has(number) ? `<span class="highlight-duplicate">${number}</span>` : number
        ).join('<br>');

        // Подготавливаем данные для отправки на сервер
        const payload = {
            links: links.map((link, index) => `${index + 1}. ${link}`),
            numbers: numbers
        };

        // Отправляем POST-запрос
        sendPostRequest(payload);
    }

    // Функция для отправки POST-запроса
    function sendPostRequest(data) {
        fetch('https://link-extractor-server.vercel.app/links/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(data)
        }).then(response => {
            console.log("Запрос отправлен", response);
        }).catch(error => {
            console.error("Ошибка при отправке запроса", error);
        });
    }

    // Копируем дублирующиеся ссылки в буфер обмена
    function copyDuplicateLinks() {
        const uniqueDuplicateLinks = Array.from(duplicateLinks).join('\n'); // Получаем уникальные дублирующиеся ссылки

        const tempTextArea = document.createElement("textarea");
        tempTextArea.style.position = "fixed";  // предотвращаем сдвиг страницы
        tempTextArea.style.opacity = "0";  // делаем его невидимым
        tempTextArea.value = uniqueDuplicateLinks;
        document.body.appendChild(tempTextArea);
        tempTextArea.select();

        try {
            document.execCommand('copy');
            alert("Дублирующиеся ссылки скопированы!");
        } catch (err) {
            alert("Ошибка при копировании: " + err);
        }

        document.body.removeChild(tempTextArea);  // удаляем временный элемент
    }

    // Копируем уникальные ссылки в буфер обмена
    function copyUniqueLinks() {
        const uniqueLinkList = Array.from(uniqueLinks).join('\n'); // Получаем уникальные ссылки

        const tempTextArea = document.createElement("textarea");
        tempTextArea.style.position = "fixed";
        tempTextArea.style.opacity = "0";
        tempTextArea.value = uniqueLinkList;
        document.body.appendChild(tempTextArea);
        tempTextArea.select();

        try {
            document.execCommand('copy');
            alert("Уникальные ссылки скопированы!");
        } catch (err) {
            alert("Ошибка при копировании: " + err);
        }

        document.body.removeChild(tempTextArea);
    }

    // Копируем результат в буфер обмена
    function copyToClipboard() {
        const output = document.getElementById('numbersOutput').innerText;

        navigator.clipboard.writeText(output).then(() => {
            alert("Результат скопирован!");
        }).catch(err => {
            alert("Ошибка при копировании: " + err);
        });
    }

    // Очищаем поля ввода и вывода
    function clearFields() {
        const confirmation = confirm("Вы уверены, что хотите очистить поле?");
        if (confirmation) {
            document.getElementById('linksInput').value = '';
            document.getElementById('linksOutput').innerHTML = '';
            document.getElementById('numbersOutput').innerHTML = '';
            duplicateLinks.clear(); // Очищаем дублирующиеся ссылки
            uniqueLinks.clear(); // Очищаем уникальные ссылки
        }
    }

</script>

</body>
</html>
